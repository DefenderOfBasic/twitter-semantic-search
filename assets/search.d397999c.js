import"./tweet-component.088c1db2.js";class x{constructor(){this.accountId=null,this.username=null,this.tweetsById={}}preprocessTweets(t){const r=[];for(let n=0;n<t.length;n++){const e=t[n].tweet;e.url=`https://x.com/${this.username}/status/${e.id}`,e.date=new Date(e.created_at),r.push(e),this.tweetsById[e.id]=e}return r}getThreads(t){const r=[];let n=0,e=0;for(let s=0;s<t.length;s++){const{in_reply_to_user_id_str:i,in_reply_to_status_id:y,full_text:f}=t[s];if(f.startsWith("RT")){n++;continue}if(i!=null&&i!=this.accountId){t[s].is_external_reply=!0,e++;continue}if(i==this.accountId){const d=y;if(!this.tweetsById[d]){console.error(`Error: failed to find tweet ${d}`);continue}if(this.tweetsById[d].is_external_reply){t[s].is_external_reply=!0,e++;continue}else this.tweetsById[d].nextTweet=t[s],t[s].parent=this.tweetsById[d]}r.push(t[s])}return{tweets:r,retweet_count:n,external_reply_count:e}}sortAscending(t){return t.sort(function(r,n){return r.date-n.date})}sortDescending(t){return t.sort(function(r,n){return n.date-r.date})}formatDate(t,r){return t.toLocaleDateString("en-US",r||{hour:"numeric",year:"numeric",month:"short",day:"2-digit"})}makeHTMLForTweet(t){return`<div class="tweet">
      <p>${t.full_text}</p>
      <div class="metadata">
        <p>${this.formatDate(t.date)}</p>
        <div class="toolbar">
          ${Number(t.retweet_count).toLocaleString()} \u{1F502} ${Number(t.favorite_count).toLocaleString()} \u{1F90D}
          <a href="${t.url}" target="_blank" style="text-decoration:none">
            <svg width="20px" height="20px" viewBox="0 0 24 24" transform="translate(0 3)" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M11 4H4V18C4 19.1046 4.89543 20 6 20H18C19.1046 20 20 19.1046 20 18V13" stroke="#292929" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/><path d="M9 15L20 4" stroke="#292929" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/><path d="M15 4H20V9" stroke="#292929" stroke-linecap="round" stroke-linejoin="round" stroke-width="2"/></svg>
          </a>
        </div>
      </div>
    </div>
    `}makeHTMLForThread(t){let r='<div class="thread">';for(;t;)r+=this.makeHTMLForTweet(t),t=t.nextTweet;return r+="</div>",r}getPopularityOverTime(t){const r=t.reduce((n,e)=>{const s=I(e.date),i=Number(e.favorite_count)+Number(e.retweet_count);return n[s]=(n[s]||0)+i,n},{});return L(Object.entries(r).map(n=>({x:n[0],y:n[1]})))}countTweetsPerDay(t){const r=t.reduce((e,s)=>{const i=I(s.date);return e[i]=(e[i]||0)+1,e},{});return Object.entries(r).sort((e,s)=>s[1]-e[1]).map(e=>({date:e[0],count:e[1]}))}countTweetsPerHour(t){const r=t.reduce((e,s)=>{const i=M(s.date);return e[i]=(e[i]||0)+1,e},{});return Object.entries(r).sort((e,s)=>s[1]-e[1]).map(e=>({date:e[0],count:e[1]}))}isTweetInteractingWith(t,r){const n=r.entities.user_mentions;if(r.in_reply_to_user_id==t)return!0;for(let e of n)if(e.id==t)return!0;return!1}}const I=a=>{const t=a.getFullYear(),r=(a.getMonth()+1).toString().padStart(2,"0"),n=a.getDate().toString().padStart(2,"0");return`${t}-${r}-${n}`},M=a=>{const t=a.getFullYear(),r=(a.getMonth()+1).toString().padStart(2,"0"),n=(a.getDate()+1).toString().padStart(2,"0"),e=a.getHours().toString().padStart(2,"0");return`${t}-${r}-${n}/${e}`},L=a=>a.sort((t,r)=>{const n=new Date(t.x),e=new Date(r.x);return n-e});H();async function H(){const a="https://fabxmporizzqflnftavs.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhYnhtcG9yaXp6cWZsbmZ0YXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjIyNDQ5MTIsImV4cCI6MjAzNzgyMDkxMn0.UIEJiUNkLsW28tBHmG-RQDW-I5JNlJLt62CSk9D_qG8",r=window.supabase.createClient(a,t),n=new URLSearchParams(window.location.search),e=n.get("username"),s=n.get("sortByDate");if(e==null){document.querySelector("#title").innerHTML="Error: missing username query param";return}const i=await(await fetch("./users.json")).json(),{query_url:y,name:f,subtitle:d,avatar:$}=i[e],D=y,l=new x;l.username=e,l.name=f,l.avatar=$,document.querySelector("#title").innerHTML=l.username,document.querySelector(".subtitle").innerHTML=d;const w=document.querySelector("#clusterThreads");document.querySelector(".search-box").addEventListener("keydown",async function(u){if(u.key==="Enter"&&!u.shiftKey){document.querySelector("#instructions").style.display="none",w.innerHTML="<h3>Searching embedding space...</h3>",u.preventDefault();const g=this.value;let c=await(await fetch(D,{method:"POST",body:JSON.stringify({searchTerm:g})})).json();console.log(c),e=="defenderofbasic"&&(console.log(c.matches),c.matches=c.matches.map(o=>({id:o.metadata.id,score:o.score}))),w.innerHTML=`<h3>Fetching ${c.matches.length} tweets...</h3>`;const k=(await r.schema("public").from("tweets").select("*").in("tweet_id",c.matches.map(o=>o.id))).data,T={};k.forEach(o=>{T[o.tweet_id]=o});let b="",h=[];for(let o=0;o<c.matches.length;o++){const p=c.matches[o],v=T[p.id];h.push({tweet:v,score:p.score})}s&&(console.log("sorting by date"),h=h.sort((o,p)=>new Date(o.tweet.created_at)-new Date(p.tweet.created_at))),console.log(h),h.forEach(o=>{b+=S(o.tweet,o.score)}),w.innerHTML=b}});function S(u,g){let m="";m+=`<p>similarity score: ${g}</p>`;const c=new Date(u.created_at),_=`https://x.com/${l.username}/status/${u.tweet_id}`;return m+=`<tweet-component
                            avatar="${l.avatar}"
                            name="${l.name}"
                            username="${l.username}"
                            timestamp="${c}"
                            likes="${u.favorite_count}"
                            retweets="${u.retweet_count}"
                            url="${_}"
                        >
                        ${C(u.full_text)}
                        </tweet-component>
                    `,m}}function C(a){let t=a.replace(/"/g,"&quot;");return t=t.replace(/'/g,"&#39;"),t=t.replace(/\n/g,"<br>"),t=t.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>'),t}
