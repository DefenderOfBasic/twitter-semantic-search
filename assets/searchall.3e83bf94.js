import"./tweet-component.088c1db2.js";import{U as D}from"./util.8203463a.js";let u;k();async function R(s){const t=await u.schema("public").from("account").select("*").eq("account_id",s),{account_display_name:m,username:w}=t.data[0],f=await u.schema("public").from("profile").select("*").eq("account_id",s),{avatar_media_url:_}=f.data[0];return{username:w,account_display_name:m,avatar_media_url:_}}async function k(){const s="https://fabxmporizzqflnftavs.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhYnhtcG9yaXp6cWZsbmZ0YXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjIyNDQ5MTIsImV4cCI6MjAzNzgyMDkxMn0.UIEJiUNkLsW28tBHmG-RQDW-I5JNlJLt62CSk9D_qG8";u=window.supabase.createClient(s,t);const m=new URLSearchParams(window.location.search),w=m.get("username"),f=m.get("sortByDate"),_="http://37.27.10.242:8080/search/text",p=new D;p.username=w,p.name=name,p.avatar="";const g=document.querySelector("#clusterThreads");document.querySelector(".search-box").addEventListener("keydown",async function(a){if(a.key==="Enter"&&!a.shiftKey){g.innerHTML="<h3>Searching embedding space...</h3>",a.preventDefault();const y=this.value;let c=await(await fetch(_,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:y,top_k:5})})).json();console.log(c);const o=c.matches.map(e=>{const{tweet_id:n}=e.metadata;return{tweet_id:n,score:e.distance}});console.log(o),g.innerHTML=`<h3>Fetching ${o.length} tweets...</h3>`;const I=(await u.schema("public").from("tweets").select("*").in("tweet_id",o.map(e=>e.tweet_id))).data,r={};I.forEach(e=>{r[e.tweet_id]=e});const i={};let d="",l=[];for(let e=0;e<c.matches.length;e++){const n=o[e],b=r[n.tweet_id];if(b==null){console.log("Missing tweet",n.tweet_id);continue}console.log(`${e} / ${c.matches.length}`);const h=b.account_id;i[h]||(i[h]=await R(h));const J=await u.schema("public").from("tweet_media").select("*").eq("tweet_id",n.tweet_id),U=J.data[0].media_url;console.log(J);const C=i[h];l.push({tweet:b,score:n.score,accountInfo:C,imageUrl:U})}f&&(console.log("sorting by date"),l=l.sort((e,n)=>new Date(e.tweet.created_at)-new Date(n.tweet.created_at))),console.log(l),l.forEach(e=>{d+=T(e.tweet,e.score,e.accountInfo,e.imageUrl)}),g.innerHTML=d}});function T(a,y,$,c){const{username:o,account_display_name:M,avatar_media_url:I}=$;let r="";r+=`<p>similarity score: ${y}</p>`;const i=new Date(a.created_at),d=`https://x.com/${p.username}/status/${a.tweet_id}`;return r+=`<tweet-component
                            avatar="${I}"
                            name="${M}"
                            username="${o}"
                            timestamp="${i}"
                            likes="${a.favorite_count}"
                            retweets="${a.retweet_count}"
                            url="${d}"
                        >
                        ${v(a.full_text)}
                        <img style="width:100%" src="${c}"/>
                        </tweet-component>
                    `,r}}function v(s){let t=s.replace(/"/g,"&quot;");return t=t.replace(/'/g,"&#39;"),t=t.replace(/\n/g,"<br>"),t=t.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>'),t}
