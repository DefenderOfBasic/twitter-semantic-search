import"./tweet-component.088c1db2.js";import{U as q}from"./util.8203463a.js";let m;C();async function x(c){const t=await m.schema("public").from("account").select("*").eq("account_id",c),{account_display_name:i,username:w}=t.data[0],f=await m.schema("public").from("profile").select("*").eq("account_id",c),{avatar_media_url:g}=f.data[0];return{username:w,account_display_name:i,avatar_media_url:g}}async function C(){const c="https://fabxmporizzqflnftavs.supabase.co",t="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZhYnhtcG9yaXp6cWZsbmZ0YXZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3MjIyNDQ5MTIsImV4cCI6MjAzNzgyMDkxMn0.UIEJiUNkLsW28tBHmG-RQDW-I5JNlJLt62CSk9D_qG8";m=window.supabase.createClient(c,t);const i=new URLSearchParams(window.location.search),w=i.get("username"),f=i.get("sortByDate"),g=Number(i.get("max")||5),L="https://social-experiments.glitch.me/proxy",d=new q;d.username=w,d.name=name,d.avatar="";const _=document.querySelector("#clusterThreads");document.querySelector(".search-box").addEventListener("keydown",async function(a){if(a.key==="Enter"&&!a.shiftKey){_.innerHTML="<h3>Searching embedding space...</h3>",a.preventDefault();const y=this.value;let s=await(await fetch(L,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({text:y,top_k:g})})).json();console.log(s);const o=s.matches.map(e=>{const{tweet_id:n}=e.metadata;return{tweet_id:n,score:e.distance}});console.log(o),_.innerHTML=`<h3>Fetching ${o.length} tweets...</h3>`;const b=(await m.schema("public").from("tweets").select("*").in("tweet_id",o.map(e=>e.tweet_id))).data,r={};b.forEach(e=>{r[e.tweet_id]=e});const l={};let p="",u=[];for(let e=0;e<s.matches.length;e++){const n=o[e],I=r[n.tweet_id];if(I==null){console.log("Missing tweet",n.tweet_id);continue}console.log(`${e} / ${s.matches.length}`),document.querySelector(".subtitle").innerHTML=`(${e} / ${s.matches.length}) images loaded`;const h=I.account_id;l[h]||(l[h]=await x(h));const $=await m.schema("public").from("tweet_media").select("*").eq("tweet_id",n.tweet_id);let J="";$.data&&$.data.length!=0&&(J=$.data[0].media_url);const U=l[h];u.push({tweet:I,score:n.score,accountInfo:U,imageUrl:J})}document.querySelector(".subtitle").innerHTML="",f&&(console.log("sorting by date"),u=u.sort((e,n)=>new Date(e.tweet.created_at)-new Date(n.tweet.created_at))),console.log(u),u.forEach(e=>{p+=S(e.tweet,e.score,e.accountInfo,e.imageUrl)}),_.innerHTML=p}});function S(a,y,M,s){const{username:o,account_display_name:T,avatar_media_url:b}=M;let r="";r+=`<p>similarity score: ${y}</p>`;const l=new Date(a.created_at),p=`https://x.com/${d.username}/status/${a.tweet_id}`;return r+=`<tweet-component
                            avatar="${b}"
                            name="${T}"
                            username="${o}"
                            timestamp="${l}"
                            likes="${a.favorite_count}"
                            retweets="${a.retweet_count}"
                            url="${p}"
                        >
                        ${D(a.full_text)}
                        <img style="width:100%" src="${s}"/>
                        </tweet-component>
                    `,r}}function D(c){let t=c.replace(/"/g,"&quot;");return t=t.replace(/'/g,"&#39;"),t=t.replace(/\n/g,"<br>"),t=t.replace(/(https?:\/\/[^\s]+)/g,'<a href="$1" target="_blank">$1</a>'),t}
